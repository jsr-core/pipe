import type { AsyncOperator } from "./operator.ts";
import type { LastAsyncOperatorReturn } from "./_common.ts";

/**
 * Composes a sequence of operators to create a new function.
 * Supports type inference for operators and the return type of the final operator.
 *
 * > [!NOTE]
 * >
 * > If more than 20 operators are used, their types default to `AsyncOperator<unknown, unknown>`,
 * > requiring explicit type annotations.
 *
 * @param operators - A sequence of operators to apply to the value.
 * @returns A function that processes the value through all operators and returns the final result.
 *
 * @example
 * ```ts
 * import { compose } from "@core/pipe/async";
 *
 * const result = await compose(
 *   (v: number) => Promise.resolve(v + 1),  // The first operator requires an explicit type
 *   (v) => Promise.resolve(v * 2),          // inferred as (v: number) => number | Promise<number>
 *   (v) => Promise.resolve(v.toString()),   // inferred as (v: number) => string | Promise<string>
 * )(1);
 * console.log(result); // "4"
 * ```
 */
export function compose<V, T01>(
  o01: AsyncOperator<V, T01>,
): AsyncOperator<V, T01>;
export function compose<V, T01, T02>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
): AsyncOperator<V, T02>;
export function compose<V, T01, T02, T03>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
): AsyncOperator<V, T03>;
export function compose<V, T01, T02, T03, T04>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
): AsyncOperator<V, T04>;
export function compose<V, T01, T02, T03, T04, T05>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
): AsyncOperator<V, T05>;
export function compose<V, T01, T02, T03, T04, T05, T06>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
): AsyncOperator<V, T06>;
export function compose<V, T01, T02, T03, T04, T05, T06, T07>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
): AsyncOperator<V, T07>;
export function compose<V, T01, T02, T03, T04, T05, T06, T07, T08>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
): AsyncOperator<V, T08>;
export function compose<V, T01, T02, T03, T04, T05, T06, T07, T08, T09>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
): AsyncOperator<V, T09>;
export function compose<V, T01, T02, T03, T04, T05, T06, T07, T08, T09, T10>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
): AsyncOperator<V, T10>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
): AsyncOperator<V, T11>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
): AsyncOperator<V, T12>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
): AsyncOperator<V, T13>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
): AsyncOperator<V, T14>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
  T15,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
  o15: AsyncOperator<T14, T15>,
): AsyncOperator<V, T15>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
  T15,
  T16,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
  o15: AsyncOperator<T14, T15>,
  o16: AsyncOperator<T15, T16>,
): AsyncOperator<V, T16>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
  T15,
  T16,
  T17,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
  o15: AsyncOperator<T14, T15>,
  o16: AsyncOperator<T15, T16>,
  o17: AsyncOperator<T16, T17>,
): AsyncOperator<V, T17>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
  T15,
  T16,
  T17,
  T18,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
  o15: AsyncOperator<T14, T15>,
  o16: AsyncOperator<T15, T16>,
  o17: AsyncOperator<T16, T17>,
  o18: AsyncOperator<T17, T18>,
): AsyncOperator<V, T18>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
  T15,
  T16,
  T17,
  T18,
  T19,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
  o15: AsyncOperator<T14, T15>,
  o16: AsyncOperator<T15, T16>,
  o17: AsyncOperator<T16, T17>,
  o18: AsyncOperator<T17, T18>,
  o19: AsyncOperator<T18, T19>,
): AsyncOperator<V, T19>;
export function compose<
  V,
  T01,
  T02,
  T03,
  T04,
  T05,
  T06,
  T07,
  T08,
  T09,
  T10,
  T11,
  T12,
  T13,
  T14,
  T15,
  T16,
  T17,
  T18,
  T19,
  T20,
>(
  o01: AsyncOperator<V, T01>,
  o02: AsyncOperator<T01, T02>,
  o03: AsyncOperator<T02, T03>,
  o04: AsyncOperator<T03, T04>,
  o05: AsyncOperator<T04, T05>,
  o06: AsyncOperator<T05, T06>,
  o07: AsyncOperator<T06, T07>,
  o08: AsyncOperator<T07, T08>,
  o09: AsyncOperator<T08, T09>,
  o10: AsyncOperator<T09, T10>,
  o11: AsyncOperator<T10, T11>,
  o12: AsyncOperator<T11, T12>,
  o13: AsyncOperator<T12, T13>,
  o14: AsyncOperator<T13, T14>,
  o15: AsyncOperator<T14, T15>,
  o16: AsyncOperator<T15, T16>,
  o17: AsyncOperator<T16, T17>,
  o18: AsyncOperator<T17, T18>,
  o19: AsyncOperator<T18, T19>,
  o20: AsyncOperator<T19, T20>,
): AsyncOperator<V, T20>;

export function compose<
  V,
  // deno-lint-ignore no-explicit-any
  AsyncOperators extends AsyncOperator<any, unknown>[],
>(
  ...operators: AsyncOperators
): AsyncOperator<V, LastAsyncOperatorReturn<AsyncOperators>>;

// deno-lint-ignore no-explicit-any
export function compose<V>(...operators: AsyncOperator<unknown, any>[]) {
  return async (value: V) => {
    return await operators.reduce(
      async (result, next) => next(await result),
      Promise.resolve(value),
    );
  };
}
